# Crisis Allowlist Tests CI Workflow
#
# Story 7.9: Cross-Platform Allowlist Testing - Task 7
#
# This workflow runs allowlist tests on every push and PR.
# CRITICAL: Deployment is BLOCKED if any allowlist test fails.

name: Allowlist Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'packages/shared/src/constants/crisis-urls/**'
      - 'packages/shared/src/constants/crisis-search/**'
      - 'packages/shared/src/services/privacyGap*.ts'
      - 'packages/shared/src/services/allowlistSyncService.ts'
      - 'packages/shared/src/adapters/**'
      - 'packages/shared/src/testing/**'
      - '.github/workflows/allowlist-tests.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'packages/shared/src/constants/crisis-urls/**'
      - 'packages/shared/src/constants/crisis-search/**'
      - 'packages/shared/src/services/privacyGap*.ts'
      - 'packages/shared/src/services/allowlistSyncService.ts'
      - 'packages/shared/src/adapters/**'
      - 'packages/shared/src/testing/**'
      - '.github/workflows/allowlist-tests.yml'
  # Run on schedule to catch stale allowlist issues
  schedule:
    - cron: '0 0 * * *' # Daily at midnight UTC

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  allowlist-tests:
    name: Allowlist Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Start Firebase Emulators
        run: |
          npm run emulators:start &
          sleep 10
        env:
          CI: true

      - name: Run Allowlist Presence Tests
        run: npm run test:allowlist:presence
        env:
          CI: true
          FIRESTORE_EMULATOR_HOST: localhost:8080
          FIREBASE_AUTH_EMULATOR_HOST: localhost:9099

      - name: Run Zero-Data-Path Tests
        run: npm run test:allowlist:zero-data-path
        env:
          CI: true
          FIRESTORE_EMULATOR_HOST: localhost:8080

      - name: Run Fuzzy Matching Tests
        run: npm run test:allowlist:fuzzy
        env:
          CI: true

      - name: Run Fallback Chain Tests
        run: npm run test:allowlist:fallback
        env:
          CI: true

      - name: Run E2E Integration Tests
        run: npm run test:allowlist:e2e
        env:
          CI: true
          FIRESTORE_EMULATOR_HOST: localhost:8080

      - name: Generate Test Report
        if: always()
        run: npm run test:allowlist:report
        env:
          CI: true

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allowlist-test-results
          path: |
            reports/allowlist-tests.json
            reports/allowlist-tests.md
          retention-days: 30

      - name: Comment PR with Results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let markdown = '';
            try {
              markdown = fs.readFileSync('reports/allowlist-tests.md', 'utf8');
            } catch (e) {
              markdown = '⚠️ Test report not generated';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: markdown
            });

      - name: Check Critical Tests
        if: always()
        run: |
          if [ -f reports/allowlist-tests.json ]; then
            CRITICAL_PASSED=$(cat reports/allowlist-tests.json | jq -r '.summary.criticalPassed')
            DEPLOYMENT_ALLOWED=$(cat reports/allowlist-tests.json | jq -r '.summary.deploymentAllowed')

            if [ "$CRITICAL_PASSED" != "true" ]; then
              echo "::error::Critical allowlist tests failed - deployment blocked"
              exit 1
            fi

            if [ "$DEPLOYMENT_ALLOWED" != "true" ]; then
              echo "::error::Allowlist test pass rate below threshold - deployment blocked"
              exit 1
            fi

            echo "::notice::All critical allowlist tests passed - deployment allowed"
          else
            echo "::error::Test report not generated - deployment blocked"
            exit 1
          fi

  deployment-gate:
    name: Deployment Gate
    runs-on: ubuntu-latest
    needs: allowlist-tests
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Download Test Results
        uses: actions/download-artifact@v4
        with:
          name: allowlist-test-results
          path: reports

      - name: Verify Deployment Status
        run: |
          if [ -f reports/allowlist-tests.json ]; then
            DEPLOYMENT_ALLOWED=$(cat reports/allowlist-tests.json | jq -r '.summary.deploymentAllowed')

            if [ "$DEPLOYMENT_ALLOWED" == "true" ]; then
              echo "✅ Allowlist tests passed - deployment may proceed"
            else
              echo "❌ Allowlist tests failed - deployment blocked"
              exit 1
            fi
          else
            echo "❌ Test report missing - deployment blocked"
            exit 1
          fi

      - name: Create Deployment Status
        if: success()
        run: |
          echo "ALLOWLIST_TESTS_PASSED=true" >> $GITHUB_ENV
          echo "Allowlist verification complete - all critical tests passed"
