# Epic 11 Retrospective: Chromebook Crisis Protection

**Date:** 2025-12-29
**Epic Status:** Complete (6/6 stories done)
**Retrospective Type:** Full Epic Retrospective

## Epic Summary

Epic 11 implemented the Chromebook Crisis Protection system - the zero data path (INV-001) invariant that ensures crisis resources are NEVER captured, protecting children seeking help in crisis situations. This is one of the most critical safety features in Fledgely, ensuring that monitoring never becomes a barrier to seeking help.

### Delivery Metrics

- **Completed Stories:** 6/6 (100%)
- **Blocked Stories:** 0
- **Epic Status:** Done
- **Test Coverage:** 76 tests passing

### Stories Completed

| Story | Title                           | Key Deliverables                                             |
| ----- | ------------------------------- | ------------------------------------------------------------ |
| 11.1  | Pre-Capture Allowlist Check     | isUrlProtected(), O(1) Set lookup, 40 bundled crisis sites   |
| 11.2  | Cached Allowlist with Fail-Safe | 24-hour sync alarm, offline resilience, version tracking     |
| 11.3  | Protected Site Visual Indicator | Purple checkmark badge, tab-specific, "Private Site" tooltip |
| 11.4  | Fuzzy URL Matching              | www normalization, case insensitive, 10 URL shorteners       |
| 11.5  | Decoy Mode for Crisis Browsing  | Placeholder images, opt-in setting, bilateral transparency   |
| 11.6  | Crisis Protection Testing       | 76 unit tests, INV-001 validation, category coverage         |

## What Went Well

1. **Zero Data Path (INV-001) Implementation**
   - Crisis URLs are checked BEFORE any capture attempt
   - Protected URLs never captured, queued, or transmitted
   - No URL or metadata ever logged for protected sites
   - Fail-safe behavior: any error skips capture (privacy first)

2. **Performance-Optimized URL Checking**
   - O(1) domain lookup using JavaScript Set
   - Target <10ms check time achieved
   - Domain normalization handles www/non-www and case variations
   - Query params and fragments ignored (hostname only)

3. **Comprehensive Crisis Resource Coverage**
   - 40 domains bundled in default allowlist:
     - 5 suicide prevention (988lifeline.org, crisistextline.org, etc.)
     - 2 sexual assault (rainn.org, nsvrc.org)
     - 4 domestic violence (thehotline.org, ncadv.org, etc.)
     - 3 child abuse (childhelp.org, preventchildabuse.org, etc.)
     - 4 mental health (samhsa.gov, nami.org, etc.)
     - 4 LGBTQ+ crisis (thetrevorproject.org, translifeline.org, etc.)
     - 4 teen/youth (teenlineonline.org, yourlifeyourvoice.org, etc.)
     - 4 general crisis (imalive.org, befrienders.org, etc.)
     - 10 URL shorteners (bit.ly, t.co, etc.) for over-blocking safety

4. **Child-Centered UX Design**
   - Purple checkmark badge (calming, not alarming)
   - "Fledgely - Private Site (not monitored)" tooltip
   - Tab-specific badges (per-tab state, not global)
   - Optional indicator (can be disabled in settings)

5. **Decoy Mode for Negative Inference Prevention**
   - Opt-in feature for high-risk situations
   - Placeholder images fill capture gaps
   - Normal timestamps prevent timeline analysis
   - isDecoy flag enables bilateral transparency on dashboard

6. **Comprehensive Test Suite**
   - 76 tests covering all crisis protection aspects
   - Domain extraction and normalization tests
   - Category coverage for all 40 bundled domains
   - Performance validation (1000 checks in <100ms)
   - Edge cases and adversarial scenario testing

## Challenges

1. **Over-Blocking Trade-Off**
   - URL shorteners block ALL links from services like bit.ly
   - This is intentional (AC7: false positives preferred to false negatives)
   - May occasionally block non-crisis shortened links
   - Acceptable trade-off for safety

2. **API Sync Placeholder**
   - Real crisis allowlist API not yet available (Epic 12)
   - syncAllowlistFromServer() is a placeholder
   - Extension uses bundled defaults successfully
   - Full API sync will be implemented with backend

3. **Badge State on Extension Load**
   - Badge state doesn't persist across service worker restarts
   - Re-checked on tab navigation and activation
   - Minor UX gap if user doesn't navigate after restart

## Key Lessons Learned

1. **Pre-Check Architecture is Critical**
   - Checking BEFORE capture ensures zero data path
   - Fail-safe default (skip on error) is essential
   - Performance optimization enables synchronous checks

2. **Domain-Level Matching is Sufficient**
   - No need to match exact URLs with query params
   - Domain extraction with normalization covers variations
   - Over-blocking at domain level is safer than under-blocking

3. **URL Shorteners Require Special Handling**
   - Can't detect redirects without network calls
   - Adding shorteners to allowlist is simpler and safer
   - Over-blocking acceptable per project values

4. **Testing Safety-Critical Features**
   - INV-001 invariant needs comprehensive test coverage
   - Category coverage ensures no crisis type is missed
   - Performance tests prevent regression on critical path

5. **Child-Centered Design Principles**
   - Visual indicators should be calming, not alarming
   - Features should be optional where possible
   - Bilateral transparency maintains trust

## Action Items

### Completed This Epic

- [x] Implement pre-capture crisis allowlist check
- [x] Create cached allowlist with 24h sync interval
- [x] Add protected site visual indicator (purple badge)
- [x] Implement fuzzy URL matching with normalization
- [x] Add decoy mode for negative inference prevention
- [x] Create comprehensive test suite (76 tests)
- [x] Add 40 crisis resources to bundled allowlist
- [x] Add 10 URL shorteners for over-blocking safety

### For Future Epics

- [ ] Epic 12: Implement real crisis allowlist API endpoint
- [ ] Epic 12: Sync allowlist updates from server
- [ ] Future: Consider community-contributed crisis resources
- [ ] Future: Add regional/international crisis resources

## Technical Debt

1. **Allowlist API Placeholder**
   - Location: `crisis-allowlist.ts` syncAllowlistFromServer()
   - Impact: Uses bundled defaults only, no server updates
   - Priority: Expected - real API in Epic 12
   - Owner: Backend team / Epic 12

2. **Badge Persistence**
   - Location: `background.ts` badge state
   - Impact: Badge may not show immediately after SW restart
   - Priority: Low - re-checked on navigation
   - Owner: Future optimization

## Files Created/Modified

### Story 11.1

- `apps/extension/src/crisis-allowlist.ts` - New crisis protection module
- `apps/extension/src/background.ts` - Integrated pre-capture check
- `apps/extension/src/event-logger.ts` - Added CRISIS_URL_PROTECTED error code

### Story 11.2

- `apps/extension/src/crisis-allowlist.ts` - Added sync functions
- `apps/extension/src/background.ts` - Added sync alarm

### Story 11.3

- `apps/extension/src/background.ts` - Badge functions, tab listeners

### Story 11.4

- `apps/extension/src/crisis-allowlist.ts` - Added URL shorteners

### Story 11.5

- `apps/extension/src/background.ts` - Decoy mode implementation

### Story 11.6

- `apps/extension/src/crisis-allowlist.test.ts` - Comprehensive test suite
- `apps/extension/src/crisis-allowlist.ts` - Added \_testExports

## Previous Epic Follow-Through

### From Epic 10 Retrospective:

| Action Item                                     | Status       | Notes      |
| ----------------------------------------------- | ------------ | ---------- |
| Implement pre-capture crisis allowlist check    | ✅ Completed | Story 11.1 |
| Replace upload placeholder with real API        | ⏳ Epic 12   | As planned |
| Integrate real family/child data from Firestore | ⏳ Epic 12   | As planned |
| Consider screenshot compression optimization    | ⏳ Future    | Not urgent |

Epic 11 successfully delivered on the primary action item from Epic 10 (pre-capture allowlist check).

## INV-001 Validation Summary

The Zero Data Path Invariant (INV-001) is now enforced:

| Check Point | Implementation                                   | Verified |
| ----------- | ------------------------------------------------ | -------- |
| Pre-capture | isUrlProtected() called BEFORE captureScreenshot | ✅       |
| No data     | Protected URLs never captured/queued/transmitted | ✅       |
| No logging  | URLs never logged (only error codes)             | ✅       |
| Fail-safe   | Any error skips capture                          | ✅       |
| Offline     | Bundled defaults always available                | ✅       |
| Performance | <10ms check time with O(1) lookup                | ✅       |
| Testing     | 76 tests validate invariant                      | ✅       |

## Next Steps

1. **Begin Epic 12: Chromebook Device Enrollment**
   - QR code generation and scanning for enrollment
   - Device registration in Firestore
   - Replace API placeholders with real endpoints
   - Integrate real family/child data

2. **Epic 12 Integration Points**
   - Real crisis allowlist API endpoint
   - Real upload API endpoint
   - Device-to-family linking

3. **Testing Recommendations**
   - Manual test on actual crisis sites (RAINN, 988, etc.)
   - Verify badge appears on protected sites
   - Test decoy mode with enabled setting
   - Verify allowlist sync alarm fires

## Team Notes

Epic 11 successfully delivered the most critical safety feature of Fledgely - the zero data path for crisis resources. This ensures that children seeking help in crisis situations are never monitored, creating a safe space within the monitoring system.

The comprehensive test suite (76 tests) provides confidence that INV-001 is enforced. The over-blocking approach (including URL shorteners) demonstrates commitment to safety over convenience.

The decoy mode feature (Story 11.5) goes beyond basic protection to address negative inference attacks - where gaps in capture timelines could reveal crisis browsing. This survivor-advocate feature ensures children in monitored situations can seek help without fear of discovery.

The extension is now ready for Epic 12 device enrollment, which will connect the client-side capture system to the backend infrastructure.

---

**Retrospective Completed By:** Claude Opus 4.5 (AI)
**Document Generated:** 2025-12-29
