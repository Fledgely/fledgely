# Story 2.2: Add Child to Family

**Status:** ready-for-dev

---

## Story

As a **parent with an existing family**,
I want **to add a child to my family with their basic profile**,
So that **I can begin creating an agreement and potentially monitoring their devices**.

---

## Acceptance Criteria

### AC1: Child Document Creation
**Given** a parent has an existing family
**When** they add a child with name, birthdate, and optional photo
**Then** a child document is created in Firestore `children/{childId}`
**And** child document validates against `childProfileSchema`
**And** childId is auto-generated by Firestore
**And** creation timestamp is recorded via `serverTimestamp()`

### AC2: Family-Child Linkage
**Given** a child document is created
**When** the creation completes successfully
**Then** child's `familyId` field references the family document
**And** family's `children` array includes the childId
**And** parent is added to child's `guardians` array with full permissions
**And** linkage is atomic (both updates succeed or both fail via transaction)

### AC3: Age Calculation
**Given** a child's birthdate is provided
**When** the child profile is created/viewed
**Then** age is calculated from birthdate in years
**And** age is used for age-appropriate defaults (Story 4.1 templates)
**And** age recalculates automatically on profile view (not stored)

### AC4: Minimum Data Principle
**Given** a parent is adding a child
**When** they fill out the form
**Then** only name and birthdate are required fields
**And** photo is optional
**And** no child account is created yet (no email, no auth)
**And** child can be added without device monitoring set up

### AC5: Form Validation & Error Handling
**Given** a parent submits invalid child data
**When** validation fails
**Then** errors display inline at field level
**And** error messages are at 6th-grade reading level (NFR65)
**And** form state is preserved (no data loss)
**And** user can correct errors and resubmit without refresh

### AC6: Redirect After Success
**Given** child creation succeeds
**When** the child document is created
**Then** parent is redirected to child dashboard or add another child prompt
**And** success message confirms child was added
**And** option to "Add another child" is shown

### AC7: Idempotent Operation
**Given** the form is submitted multiple times (accidental double-click)
**When** creation is already in progress
**Then** submit button is disabled during processing
**And** only one child document is created
**And** subsequent clicks are ignored until operation completes

### AC8: Accessibility
**Given** a parent using assistive technology
**When** they add a child
**Then** all form fields are keyboard accessible (NFR43)
**And** form labels are properly associated with inputs
**And** error states are announced to screen readers via aria-live
**And** color contrast meets 4.5:1 minimum (NFR45)
**And** focus moves to first error on validation failure
**And** date picker is keyboard accessible

---

## Tasks / Subtasks

### Task 1: Create Child Profile Schema (packages/contracts/src/child.schema.ts)
- [ ] 1.1 Create `childProfileSchema` with Zod validation
- [ ] 1.2 Define required fields: `id`, `familyId`, `firstName`, `birthdate`, `createdAt`, `createdBy`
- [ ] 1.3 Define optional fields: `lastName`, `photoUrl`, `nickname`
- [ ] 1.4 Create `childGuardianSchema` for guardian permissions on child (uid, permissions, grantedAt)
- [ ] 1.5 Add guardians array to childProfileSchema (min 1 guardian required)
- [ ] 1.6 Create `childProfileFirestoreSchema` for Firestore Timestamp handling
- [ ] 1.7 Create `createChildInputSchema` for form validation (name, birthdate, optional photo)
- [ ] 1.8 Add `calculateAge(birthdate: Date)` helper function
- [ ] 1.9 Add Firebase ID validation (same pattern as family.schema.ts)
- [ ] 1.10 Export types: `ChildProfile`, `ChildGuardian`, `CreateChildInput`
- [ ] 1.11 Export from packages/contracts/src/index.ts
- [ ] 1.12 Write unit tests for schema validation (40+ tests)

### Task 2: Create Child Service (apps/web/src/services/childService.ts)
- [ ] 2.1 Create `childService` with Firestore operations
- [ ] 2.2 Implement `addChildToFamily(familyId, input, userId)` - creates child + updates family
- [ ] 2.3 Use Firestore transaction for atomic child creation + family children array update
- [ ] 2.4 Validate user is guardian in family before allowing add
- [ ] 2.5 Use `serverTimestamp()` for timestamps
- [ ] 2.6 Generate unique childId using Firestore auto-ID
- [ ] 2.7 Return optimistic data immediately after transaction (same pattern as familyService)
- [ ] 2.8 Implement `getChild(childId)` - fetches child by ID
- [ ] 2.9 Implement `getChildrenForFamily(familyId)` - fetches all children in family
- [ ] 2.10 Add error messages at 6th-grade reading level

### Task 3: Create useChild Hook (apps/web/src/hooks/useChild.ts)
- [ ] 3.1 Create `useChild` hook for child state management
- [ ] 3.2 Expose `children`, `loading`, `error`, `addChild` function
- [ ] 3.3 Integrate with `useFamily` hook for family context
- [ ] 3.4 Auto-fetch children when family is loaded
- [ ] 3.5 Handle loading states during child operations
- [ ] 3.6 Optimistic update for children array on add

### Task 4: Create Add Child Form Components
- [ ] 4.1 Create `apps/web/src/components/child/AddChildForm.tsx`
- [ ] 4.2 Use react-hook-form with Zod resolver (createChildInputSchema)
- [ ] 4.3 Name input with validation (required, min 1 char, max 50 chars)
- [ ] 4.4 Accessible date picker for birthdate (keyboard navigable, announces to screen readers)
- [ ] 4.5 Optional photo upload placeholder (UI only, actual upload is future story)
- [ ] 4.6 Form-level error display with aria-live announcements
- [ ] 4.7 Submit button with loading state and disabled during submission
- [ ] 4.8 44x44px minimum touch targets (NFR49)

### Task 5: Create Add Child Page
- [ ] 5.1 Create `apps/web/src/app/(protected)/onboarding/add-child/page.tsx`
- [ ] 5.2 Verify user has a family (redirect to create-family if not)
- [ ] 5.3 Display AddChildForm component
- [ ] 5.4 Handle form submission and call childService
- [ ] 5.5 Show success state with options: "Add another child" or "Continue to dashboard"
- [ ] 5.6 Handle errors with retry option
- [ ] 5.7 Full accessibility support (WCAG 2.1 AA)
- [ ] 5.8 Add SafetyResourcesLink in footer (consistent with create-family page)

### Task 6: Update Family Dashboard for Children Display
- [ ] 6.1 Update dashboard to show children list if any exist
- [ ] 6.2 Show "Add your first child" empty state if no children
- [ ] 6.3 Each child displays: name, age, basic status
- [ ] 6.4 "Add another child" button when children exist

### Task 7: Create Firestore Security Rules for Children
- [ ] 7.1 Add security rules for children collection in firestore.rules
- [ ] 7.2 Only authenticated guardians can create children in their family
- [ ] 7.3 Only guardians with 'full' permissions can read/update children
- [ ] 7.4 Verify familyId in child matches user's familyId
- [ ] 7.5 Children cannot be deleted (soft delete in future, for audit)
- [ ] 7.6 Use explicit index checking (same pattern as families collection)

### Task 8: Write Tests
- [ ] 8.1 Unit tests for `childProfileSchema` validation (40+ tests)
- [ ] 8.2 Unit tests for `childService` operations (mocked Firestore) (25+ tests)
- [ ] 8.3 Unit tests for `useChild` hook (15+ tests)
- [ ] 8.4 Unit tests for AddChildForm component
- [ ] 8.5 Integration test: add child flow end-to-end
- [ ] 8.6 Test error handling and recovery
- [ ] 8.7 Test age calculation edge cases (leap years, timezone)
- [ ] 8.8 Adversarial tests: cross-family child access prevention
- [ ] 8.9 Adversarial tests: input validation (path injection, XSS)
- [ ] 8.10 Accessibility tests for add-child page

---

## Dev Notes

### Critical Requirements

This story creates child profiles within families. Key patterns from Story 2.1:

1. **Zod-First Types** - `childProfileSchema` is the source of truth for ChildProfile type
2. **Direct Firestore SDK** - No ORM abstractions per project guidelines
3. **Server Timestamps** - Use `serverTimestamp()` for reliable timestamps
4. **Transaction-Based Operations** - Atomic child creation + family update
5. **Optimistic Returns** - Return data immediately after transaction (don't re-read)
6. **Explicit Index Checking** - Firestore rules must use index checking, not `.map()` (security fix from Story 2.1)

### Architecture Patterns

**Child Profile Schema (following family.schema.ts pattern):**
```typescript
// packages/contracts/src/child.schema.ts
import { z } from 'zod'

/**
 * Child guardian reference - represents a guardian's permissions on a child
 */
export const childGuardianSchema = z.object({
  /** Guardian's user uid (references users/{uid}) */
  uid: z.string().min(1, 'Guardian ID is required'),

  /** Guardian's permission level for this child */
  permissions: z.enum(['full', 'readonly']),

  /** When the guardian was granted access */
  grantedAt: z.date(),
})

export type ChildGuardian = z.infer<typeof childGuardianSchema>

/**
 * Firebase document ID regex - validates IDs are safe for Firestore paths
 */
const FIREBASE_ID_REGEX = /^[^/\x00]+$/
const MAX_FIREBASE_ID_LENGTH = 200

/**
 * Complete child profile document
 */
export const childProfileSchema = z.object({
  /** Unique child identifier (Firestore document ID) */
  id: z.string().min(1, 'Child ID is required'),

  /** Reference to parent family */
  familyId: z.string().min(1, 'Family ID is required'),

  /** Child's first name */
  firstName: z.string()
    .min(1, 'First name is required')
    .max(50, 'Name is too long'),

  /** Child's last name (optional) */
  lastName: z.string().max(50).optional(),

  /** Child's nickname (optional, what they prefer to be called) */
  nickname: z.string().max(30).optional(),

  /** Child's date of birth (for age calculation) */
  birthdate: z.date(),

  /** Profile photo URL (optional) */
  photoUrl: z.string().url().optional(),

  /** Guardians with access to this child's data */
  guardians: z.array(childGuardianSchema).min(1, 'At least one guardian is required'),

  /** When the child profile was created */
  createdAt: z.date(),

  /** User uid who created the child profile */
  createdBy: z.string().min(1, 'Creator ID is required'),
})

export type ChildProfile = z.infer<typeof childProfileSchema>

/**
 * Input schema for creating a new child
 */
export const createChildInputSchema = z.object({
  firstName: z.string()
    .min(1, 'Name is required')
    .max(50, 'Name cannot be more than 50 characters')
    .trim()
    .refine((val) => val.length > 0, 'Name cannot be only spaces'),

  lastName: z.string().max(50).optional(),

  birthdate: z.date()
    .refine((date) => date <= new Date(), 'Birthdate cannot be in the future')
    .refine((date) => {
      const minDate = new Date()
      minDate.setFullYear(minDate.getFullYear() - 18)
      return date >= minDate
    }, 'Child must be under 18 years old'),

  photoUrl: z.string().url().optional(),
})

export type CreateChildInput = z.infer<typeof createChildInputSchema>

/**
 * Calculate age from birthdate in years
 */
export function calculateAge(birthdate: Date): number {
  const today = new Date()
  let age = today.getFullYear() - birthdate.getFullYear()
  const monthDiff = today.getMonth() - birthdate.getMonth()

  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthdate.getDate())) {
    age--
  }

  return age
}
```

**Child Service Pattern (following familyService.ts):**
```typescript
// apps/web/src/services/childService.ts
'use client'

import {
  doc,
  getDoc,
  getDocs,
  collection,
  query,
  where,
  serverTimestamp,
  runTransaction,
  arrayUnion,
  type Timestamp,
} from 'firebase/firestore'
import { db } from '@/lib/firebase'
import {
  childProfileSchema,
  createChildInputSchema,
  type ChildProfile,
  type CreateChildInput,
} from '@fledgely/contracts'

const CHILDREN_COLLECTION = 'children'
const FAMILIES_COLLECTION = 'families'

/**
 * Add a child to a family
 * Uses transaction to atomically create child and update family children array
 */
export async function addChildToFamily(
  familyId: string,
  input: CreateChildInput,
  userId: string
): Promise<ChildProfile> {
  // Validate input
  createChildInputSchema.parse(input)

  const childRef = doc(collection(db, CHILDREN_COLLECTION))
  const familyRef = doc(db, FAMILIES_COLLECTION, familyId)

  // Capture timestamp for optimistic return
  const now = new Date()

  await runTransaction(db, async (transaction) => {
    // Verify family exists and user is a guardian with full permissions
    const familyDoc = await transaction.get(familyRef)
    if (!familyDoc.exists()) {
      throw new Error('Family not found')
    }

    const familyData = familyDoc.data()
    const guardians = familyData.guardians as Array<{uid: string, permissions: string}>
    const userGuardian = guardians.find(g => g.uid === userId)

    if (!userGuardian || userGuardian.permissions !== 'full') {
      throw new Error('You do not have permission to add children')
    }

    // Create child document
    const childData = {
      id: childRef.id,
      familyId,
      firstName: input.firstName,
      lastName: input.lastName || null,
      birthdate: input.birthdate, // Will be converted by Firestore
      photoUrl: input.photoUrl || null,
      guardians: [{
        uid: userId,
        permissions: 'full',
        grantedAt: serverTimestamp(),
      }],
      createdAt: serverTimestamp(),
      createdBy: userId,
    }

    transaction.set(childRef, childData)

    // Update family children array
    transaction.update(familyRef, {
      children: arrayUnion(childRef.id),
    })
  })

  // Return optimistic data
  return childProfileSchema.parse({
    id: childRef.id,
    familyId,
    firstName: input.firstName,
    lastName: input.lastName,
    birthdate: input.birthdate,
    photoUrl: input.photoUrl,
    guardians: [{
      uid: userId,
      permissions: 'full',
      grantedAt: now,
    }],
    createdAt: now,
    createdBy: userId,
  })
}
```

### Firestore Security Rules for Children

```javascript
// Add to firestore.rules

// ============================================
// CHILDREN COLLECTION (Story 2.2)
// ============================================
// Stores child profile documents
//
// Security invariants:
// 1. Only guardians can create children in their family
// 2. Only guardians with 'full' permissions can read/update
// 3. Children cannot be deleted (audit requirement)
// 4. familyId must match the creator's family
// ============================================

match /children/{childId} {
  // Helper function to check if user is a guardian in the child's family
  function isChildGuardian() {
    let guardians = resource.data.guardians;
    let uid = request.auth.uid;
    return request.auth != null &&
      guardians is list &&
      guardians.size() >= 1 &&
      guardians.size() <= 10 &&
      (
        (guardians.size() >= 1 && guardians[0].uid == uid) ||
        (guardians.size() >= 2 && guardians[1].uid == uid) ||
        (guardians.size() >= 3 && guardians[2].uid == uid) ||
        (guardians.size() >= 4 && guardians[3].uid == uid) ||
        (guardians.size() >= 5 && guardians[4].uid == uid) ||
        (guardians.size() >= 6 && guardians[5].uid == uid) ||
        (guardians.size() >= 7 && guardians[6].uid == uid) ||
        (guardians.size() >= 8 && guardians[7].uid == uid) ||
        (guardians.size() >= 9 && guardians[8].uid == uid) ||
        (guardians.size() >= 10 && guardians[9].uid == uid)
      );
  }

  // Helper function to check if user has full permissions on child
  function hasFullChildPermissions() {
    let guardians = resource.data.guardians;
    let uid = request.auth.uid;
    return request.auth != null &&
      guardians is list &&
      guardians.size() >= 1 &&
      guardians.size() <= 10 &&
      (
        (guardians.size() >= 1 && guardians[0].uid == uid && guardians[0].permissions == 'full') ||
        (guardians.size() >= 2 && guardians[1].uid == uid && guardians[1].permissions == 'full') ||
        (guardians.size() >= 3 && guardians[2].uid == uid && guardians[2].permissions == 'full') ||
        (guardians.size() >= 4 && guardians[3].uid == uid && guardians[3].permissions == 'full') ||
        (guardians.size() >= 5 && guardians[4].uid == uid && guardians[4].permissions == 'full') ||
        (guardians.size() >= 6 && guardians[5].uid == uid && guardians[5].permissions == 'full') ||
        (guardians.size() >= 7 && guardians[6].uid == uid && guardians[6].permissions == 'full') ||
        (guardians.size() >= 8 && guardians[7].uid == uid && guardians[7].permissions == 'full') ||
        (guardians.size() >= 9 && guardians[8].uid == uid && guardians[8].permissions == 'full') ||
        (guardians.size() >= 10 && guardians[9].uid == uid && guardians[9].permissions == 'full')
      );
  }

  // Users can create children if:
  // - They are authenticated
  // - They set themselves as the creator
  // - They are the only guardian on creation (exactly 1)
  // - They have 'full' permissions on the child
  // - familyId matches a family they are guardian of
  allow create: if request.auth != null &&
    request.resource.data.createdBy == request.auth.uid &&
    request.resource.data.guardians is list &&
    request.resource.data.guardians.size() == 1 &&
    request.resource.data.guardians[0].uid == request.auth.uid &&
    request.resource.data.guardians[0].permissions == 'full' &&
    request.resource.data.familyId is string &&
    request.resource.data.familyId.size() > 0 &&
    // Verify user is guardian in the specified family
    exists(/databases/$(database)/documents/families/$(request.resource.data.familyId));

  // Only guardians can read children
  allow read: if isChildGuardian();

  // Only guardians with full permissions can update
  allow update: if hasFullChildPermissions() &&
    // Prevent changing createdBy, createdAt, familyId (immutable)
    request.resource.data.createdBy == resource.data.createdBy &&
    request.resource.data.createdAt == resource.data.createdAt &&
    request.resource.data.familyId == resource.data.familyId;

  // Children cannot be deleted (audit requirement)
  allow delete: if false;
}
```

### NFR Compliance Checklist

| NFR | Requirement | Implementation |
|-----|-------------|----------------|
| INV-001 | Types from Zod only | childProfileSchema with z.infer<> |
| INV-002 | Direct Firestore SDK | runTransaction, getDoc directly |
| INV-003 | Cross-family isolation | Security rules verify familyId |
| NFR42 | WCAG 2.1 AA | Accessible form, aria-live |
| NFR43 | Keyboard accessible | All elements tab-navigable |
| NFR45 | 4.5:1 color contrast | Use existing design system |
| NFR49 | 44x44px touch targets | Form buttons sized appropriately |
| NFR65 | 6th-grade reading level | Simple error messages |

### Error Handling

**Error Message Mapping (6th-grade reading level):**
```typescript
const ERROR_MESSAGES: Record<string, string> = {
  'family-not-found': 'We could not find your family. Please try signing in again.',
  'permission-denied': 'You cannot add children to this family.',
  'invalid-birthdate': 'Please enter a valid birthdate.',
  'child-too-old': 'Children must be under 18 years old.',
  'name-required': 'Please enter your child\'s name.',
  'unavailable': 'Connection problem. Please check your internet and try again.',
  default: 'Something went wrong. Please try again.',
}
```

### Date Picker Accessibility Requirements

The birthdate picker MUST be accessible:
- Use a native date input with fallback to keyboard-navigable calendar
- Support arrow keys for date navigation
- Announce selected date to screen readers
- Accept multiple date formats (MM/DD/YYYY, YYYY-MM-DD)
- Show clear error if date is invalid
- Consider using shadcn/ui `<Calendar>` component with accessible markup

### Previous Story Intelligence

**Story 2.1 Learnings:**
1. Transaction-based operations work well for atomic updates
2. Optimistic returns avoid serverTimestamp race conditions
3. Explicit index checking in Firestore rules (not `.map()`) is required for security
4. Error messages at 6th-grade reading level improve UX
5. Screen reader announcements via aria-live for loading/success states
6. Adversarial tests catch input validation edge cases

**Files from Story 2.1 to Reference:**
- `packages/contracts/src/family.schema.ts` - Schema pattern to follow
- `apps/web/src/services/familyService.ts` - Service pattern to follow
- `apps/web/src/hooks/useFamily.ts` - Hook pattern to follow
- `apps/web/src/app/(protected)/onboarding/create-family/page.tsx` - Page pattern
- `packages/firebase-rules/firestore.rules` - Security rules pattern

### Git Intelligence

**Recent Commits:**
- `7fefc0c feat(family): implement Story 2.1 - Family Creation` - Current patterns
- Story 2.1 established the transaction pattern for family/user atomic updates

### Dependencies

**Already Installed:**
- `firebase` (in apps/web)
- `zod` (in packages/contracts)
- `react-hook-form` (in apps/web)
- `@hookform/resolvers` (in apps/web)
- shadcn/ui components (in apps/web)

**No New Dependencies Required**

### File Structure

**Files to Create:**
```
packages/contracts/src/child.schema.ts
packages/contracts/src/child.schema.test.ts
apps/web/src/services/childService.ts
apps/web/src/services/childService.test.ts
apps/web/src/hooks/useChild.ts
apps/web/src/hooks/useChild.test.ts
apps/web/src/components/child/AddChildForm.tsx
apps/web/src/components/child/AddChildForm.test.tsx
apps/web/src/app/(protected)/onboarding/add-child/page.tsx
```

**Files to Modify:**
```
packages/contracts/src/index.ts              # Export childProfileSchema
packages/firebase-rules/firestore.rules      # Add children collection rules
apps/web/src/app/(protected)/dashboard/page.tsx  # Show children list
```

---

## References

- [Source: docs/epics/epic-list.md#Story-2.2] - Original story requirements
- [Source: docs/project_context.md] - Architecture patterns
- [Source: packages/contracts/src/family.schema.ts] - Schema pattern to follow
- [Source: apps/web/src/services/familyService.ts] - Service pattern to follow
- [Source: docs/sprint-artifacts/stories/2-1-family-creation.md] - Previous story learnings
- [Firebase Firestore Transactions](https://firebase.google.com/docs/firestore/manage-data/transactions)

---

## Dev Agent Record

### Context Reference
- Story context: docs/sprint-artifacts/stories/2-2-add-child-to-family.md
- Epic context: Epic 2 - Family Creation & Child Profiles
- Previous story: Story 2.1 - Family Creation (completed)

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
(To be filled during implementation)

### Completion Notes List
- This is Story 2 of 8 in Epic 2
- Builds on Story 2.1 family foundation
- Story 2.3 (Custody Arrangement) depends on child profiles
- Uses same transaction pattern as Story 2.1
- Follows accessibility patterns established in Epic 1

### File List
**To Create:**
- `packages/contracts/src/child.schema.ts`
- `packages/contracts/src/child.schema.test.ts`
- `apps/web/src/services/childService.ts`
- `apps/web/src/services/childService.test.ts`
- `apps/web/src/hooks/useChild.ts`
- `apps/web/src/hooks/useChild.test.ts`
- `apps/web/src/components/child/AddChildForm.tsx`
- `apps/web/src/components/child/AddChildForm.test.tsx`
- `apps/web/src/app/(protected)/onboarding/add-child/page.tsx`

**To Modify:**
- `packages/contracts/src/index.ts`
- `packages/firebase-rules/firestore.rules`
- `apps/web/src/app/(protected)/dashboard/page.tsx`
