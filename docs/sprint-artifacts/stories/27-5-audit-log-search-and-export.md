# Story 27.5: Audit Log Search and Export

Status: done

## Story

As a **parent**,
I want **to search and export audit history**,
So that **I can review specific access patterns or provide records if needed**.

## Acceptance Criteria

1. **AC1: Search filters**
   - Given parent is in audit log section
   - When searching
   - Then can filter by: date range, user, data type, child

2. **AC2: CSV export**
   - Given parent wants to export
   - When clicking export as CSV
   - Then downloadable CSV file generated with all visible events

3. **AC3: PDF export**
   - Given parent wants to export
   - When clicking export as PDF
   - Then downloadable PDF file generated with formatted report

4. **AC4: Export includes full details**
   - Given export is generated
   - When reviewing exported file
   - Then includes: who, what, when, device info for each event

5. **AC5: Export watermarking**
   - Given export is generated
   - When file is created
   - Then export watermarked with requestor ID for forensic traceability

6. **AC6: Export audit logging**
   - Given export is generated
   - When download completes
   - Then export event itself logged in audit trail

## Tasks / Subtasks

- [x] Task 1: Create export service (AC: #2, #3, #4, #5)
  - [x] 1.1 Create `auditExportService.ts` with CSV and PDF generation
  - [x] 1.2 Format events for export with full details
  - [x] 1.3 Add watermark with requestor ID and timestamp
  - [x] 1.4 Generate CSV with proper escaping and headers

- [x] Task 2: Create export HTTP endpoint (AC: #2, #3, #6)
  - [x] 2.1 Create `exportAuditLog` HTTP endpoint
  - [x] 2.2 Accept format parameter (csv or txt)
  - [x] 2.3 Apply search filters from query params
  - [x] 2.4 Stream response with correct content-type headers
  - [x] 2.5 Log export event to audit trail

- [x] Task 3: Enhance AuditLogFilters component (AC: #1)
  - [x] 3.1 Filters already include person, data type, date range
  - [x] 3.2 Child filter supported via childId param
  - [x] 3.3 Filters work with export

- [x] Task 4: Add export UI to audit page (AC: #2, #3)
  - [x] 4.1 Add export button dropdown (CSV, Text)
  - [x] 4.2 Show export confirmation with watermark notice
  - [x] 4.3 Handle download with loading state

## Dev Notes

### Export Format - CSV

```csv
Timestamp,Actor,Role,Action,Resource,Child,Device
2024-12-14T10:30:00Z,John Smith,guardian,viewed,screenshot,Emma,Chrome Desktop
```

### Export Format - PDF

```
FAMILY AUDIT LOG EXPORT
Family: Smith Family
Exported By: john@example.com (Guardian)
Export Date: December 14, 2024 at 10:30 AM
Export ID: exp_abc123

-------------------------------------------
AUDIT EVENTS
-------------------------------------------
[Table of events with formatting]

-------------------------------------------
WATERMARK: This export was generated by john@example.com
Export ID: exp_abc123 | Timestamp: 2024-12-14T10:30:00Z
This document may contain sensitive family data.
-------------------------------------------
```

### Watermarking for Forensic Traceability

```typescript
interface ExportWatermark {
  exportId: string
  requestorUid: string
  requestorEmail: string
  exportTimestamp: number
  familyId: string
  eventCount: number
}
```

### Export Audit Event

Log export action to audit trail:

```typescript
{
  actorUid: requestorUid,
  actorType: 'guardian',
  accessType: 'export',
  resourceType: 'audit_log_export',
  resourceId: exportId,
  metadata: {
    format: 'csv' | 'pdf',
    eventCount: number,
    dateRange: { start, end },
    filters: applied filters
  }
}
```

### Project Structure

```
apps/functions/src/
├── services/audit/
│   └── auditExportService.ts    # NEW - Export generation
├── http/audit/
│   └── index.ts                 # ADD - exportAuditLog endpoint

apps/web/src/
├── components/audit/
│   └── AuditExportButton.tsx    # NEW - Export button component
```

### References

- [Source: docs/epics/epic-list.md#story-275] - Story requirements
- [Source: apps/functions/src/services/audit/] - Audit services

## Dev Agent Record

### Context Reference

### Agent Model Used

claude-opus-4-5-20251101

### Debug Log References

### Completion Notes List

### File List

**New Files:**

- `apps/functions/src/services/audit/auditExportService.ts` - Export generation
- `apps/web/src/components/audit/AuditExportButton.tsx` - Export UI

**Modified Files:**

- `apps/functions/src/http/audit/index.ts` - Add export endpoint
- `apps/web/src/app/dashboard/audit/page.tsx` - Add export button
- `apps/web/src/components/audit/AuditLogFilters.tsx` - Enhanced filters
