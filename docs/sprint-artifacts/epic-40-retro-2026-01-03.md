# Epic 40 Retrospective: Advanced Shared Custody & Location Features

**Date:** 2026-01-03
**Epic:** 40 - Advanced Shared Custody & Location Features
**Stories Completed:** 6/6

---

## Executive Summary

Epic 40 successfully implemented a comprehensive location-based parental control system designed specifically for shared custody scenarios. The epic delivered dual-guardian consent for enabling location features, single-guardian instant disable for safety, Safe Escape mode with 72-hour silent period for survivor protection, geofence-based rule configuration, location transition handling with grace periods, child privacy controls with bilateral transparency, and abuse pattern detection with auto-disable capability. All 6 stories were completed with 986+ tests providing robust coverage.

---

## Story Completion Summary

| Story | Title                                | Tasks | Tests | Status |
| ----- | ------------------------------------ | ----- | ----- | ------ |
| 40-1  | Location-Based Rule Opt-In           | 9     | 140   | Done   |
| 40-2  | Location-Specific Rule Configuration | 10    | 259   | Done   |
| 40-3  | Fleeing Mode - Safe Escape           | 8     | 160+  | Done   |
| 40-4  | Location Transition Handling         | 8     | ~100  | Done   |
| 40-5  | Location Privacy Controls            | 10    | 154   | Done   |
| 40-6  | Location Feature Abuse Prevention    | 11    | 173   | Done   |

**Total Epic Test Coverage:** 986+ tests across 50+ test files

---

## What Went Well

### 1. Dual-Guardian Consent Pattern

The location feature opt-in follows the established two-parent approval pattern:

- First guardian requests opt-in
- Second guardian must approve (no auto-enable)
- Child notified in child-friendly language
- Single guardian can disable instantly (safety priority)
- 72-hour expiry on pending requests

### 2. Survivor Advocacy: Safe Escape Mode

The Safe Escape implementation prioritizes safety over all other concerns:

- Single-tap activation (no confirmation delay)
- 72-hour silent period (no notifications to other family members)
- Location history cleared immediately
- Child gets same protections as adults
- Only activator can re-enable

### 3. Non-Configurable Abuse Detection Thresholds

Security by design prevents gaming of abuse detection:

```typescript
const LOCATION_ABUSE_THRESHOLDS = {
  ASYMMETRIC_CHECK_RATIO: 10, // 10x more checks triggers alert
  ASYMMETRIC_CHECK_WINDOW_DAYS: 7, // Rolling 7-day window
  FREQUENT_CHANGES_COUNT: 3, // 3+ changes in 24h
  FREQUENT_CHANGES_WINDOW_HOURS: 24,
  AUTO_DISABLE_ALERT_COUNT: 3, // 3 alerts = auto-disable
  AUTO_DISABLE_WINDOW_DAYS: 30,
}
```

### 4. Bilateral Transparency

All location-related information is symmetric:

- Both parents receive identical abuse alerts
- Child sees same location history as parents
- Alert messaging never blames either parent
- Neutral, non-judgmental resource recommendations

### 5. Geofence Transition Grace Period

The 5-minute grace period handles location transitions gracefully:

- Child notified when transition detected
- Rules don't change immediately (can finish current activity)
- Time recalculated proportionally at new location
- Unknown locations default to more permissive rules

### 6. Previous Retrospective Action Items Applied

- ✅ Verified story status updates after each task
- ✅ Ran lint after each implementation
- ✅ Fixed ESLint errors before commits (unused imports, require statements)
- ✅ Used vi.hoisted() for proper mock hoisting in ESM tests

---

## What Could Be Improved

### 1. ESM Module Resolution in Tests

**Issue:** Dynamic `require('@fledgely/shared')` calls in test files caused module resolution errors:

```
Directory import '.../contracts' is not supported resolving ES modules
```

**Resolution:** Changed to static imports at top of file:

```typescript
// Before (broken)
const { schema } = require('@fledgely/shared')

// After (working)
import { schema } from '@fledgely/shared'
```

**Recommendation:** Document that all test imports must be static, not dynamic.

### 2. Vitest Mock Hoisting

**Issue:** Mock functions referencing variables before they were defined:

```typescript
// This breaks - mockFn referenced before declaration
vi.mock('firebase-admin/firestore', () => ({
  getFirestore: () => ({ collection: mockCollection }),
}))
const mockCollection = vi.fn()
```

**Resolution:** Use vi.hoisted() to declare mocks before hoisting:

```typescript
const { mockCollection } = vi.hoisted(() => ({
  mockCollection: vi.fn(),
}))
vi.mock('firebase-admin/firestore', () => ({
  getFirestore: () => ({ collection: mockCollection }),
}))
```

**Recommendation:** Document vi.hoisted() pattern for all Firestore mocks.

### 3. Unused Import Cleanup

**Issue:** Several files had unused imports after refactoring:

- LOCATION_ABUSE_RESOURCES in sendLocationAbuseAlert.ts
- FieldValue in trackLocationAccess.ts
- getGuardianAccessCounts in test files

**Recommendation:** Run `yarn lint` after each file modification, not just at end.

---

## Technical Patterns Established

### 1. Dual-Guardian Consent Pattern

```typescript
// Request schema with 72-hour expiry
const locationOptInRequestSchema = z.object({
  id: z.string(),
  familyId: z.string(),
  requestedByUid: z.string(),
  status: z.enum(['pending', 'approved', 'declined', 'expired']),
  approvedByUid: z.string().nullable(),
  expiresAt: z.date(),
})

// Approval validates different guardian
if (request.requestedByUid === callerUid) {
  throw new Error('Cannot approve own request')
}
```

### 2. Location Zone Geofencing

```typescript
const locationZoneSchema = z.object({
  id: z.string(),
  type: z.enum(['home_1', 'home_2', 'school', 'other']),
  latitude: z.number(),
  longitude: z.number(),
  radiusMeters: z.number().min(100).max(2000).default(500),
})

// Haversine formula for distance calculation
function calculateDistanceMeters(lat1, lon1, lat2, lon2) {
  const R = 6371000 // Earth's radius in meters
  // ... spherical law of cosines
}

function isWithinZone(deviceLat, deviceLon, zone) {
  const distance = calculateDistanceMeters(...)
  return distance <= zone.radiusMeters
}
```

### 3. Safe Escape Silent Period

```typescript
const SAFE_ESCAPE_SILENT_PERIOD_MS = 72 * 60 * 60 * 1000 // 72 hours

// Scheduled function after silent period
async function sendSafeEscapeNotifications() {
  const now = Date.now()
  const silentPeriodEnd = activation.activatedAt + SILENT_PERIOD_MS

  if (now >= silentPeriodEnd && !activation.notificationSentAt) {
    // Send neutral notification: "Location features paused"
    // Never indicate emergency or escape
  }
}
```

### 4. Abuse Detection Scheduling

```typescript
// Daily scheduler at 3 AM
const detectLocationAbuse = onSchedule('0 3 * * *', async () => {
  await detectAsymmetricChecks() // 10x ratio in 7 days
  await detectFrequentRuleChanges() // 3+ in 24h before exchange
  await detectCrossCustodyRestriction() // Rules targeting other parent's time
})

// Auto-disable at 4 AM
const autoDisableLocationForAbuse = onSchedule('0 4 * * *', async () => {
  // Disable if 3+ alerts in 30 days
})
```

### 5. Location Transition Grace Period

```typescript
const LOCATION_TRANSITION_GRACE_PERIOD_MS = 5 * 60 * 1000 // 5 minutes

const locationTransitionSchema = z.object({
  fromZoneId: z.string().nullable(),
  toZoneId: z.string().nullable(),
  detectedAt: z.date(),
  gracePeriodEndsAt: z.date(),
  appliedAt: z.date().nullable(),
})

// Child message: "You're now at Mom's - rules will update in 5 minutes"
```

---

## Key Business Rules Implemented

### Location Feature Controls

- **Default:** Disabled for all families
- **Enable:** Requires both guardians
- **Disable:** Any single guardian, instant

### Geofence Configuration

- **Radius:** 100m minimum, 2000m maximum, 500m default
- **Zone Types:** home_1, home_2, school, other
- **School Default:** Education-only mode enabled

### Safe Escape (Fleeing Mode)

- **Activation:** Instant, no confirmation
- **Silent Period:** 72 hours (no notifications)
- **History:** Cleared immediately
- **Re-enable:** Only activator can re-enable
- **Child Protection:** Same rights as adults

### Abuse Pattern Detection

- **Asymmetric Checks:** Alert if 10x difference in 7 days
- **Frequent Changes:** Alert if 3+ changes in 24h before custody exchange
- **Cross-Custody Restriction:** Alert if rules target other parent's time
- **Auto-Disable:** After 3 alerts in 30 days
- **Thresholds:** Non-configurable (prevents gaming)

### Location Privacy

- **Bilateral Transparency:** Child sees same data as parents
- **Data Retention:** Deleted at age 18
- **No Third-Party Sharing:** Location never sold or used for analytics
- **Child Request:** Can request location features be disabled

---

## Previous Retrospective Follow-Through

| Epic 39 Action Item                         | Status                                |
| ------------------------------------------- | ------------------------------------- |
| Firestore mock helper utility               | ❌ Not addressed (complexity remains) |
| Document useCallback pattern for validation | ❌ Not addressed                      |
| Verify story status updates immediately     | ✅ Applied                            |
| Firestore migration patterns                | ❌ Not addressed (carried forward)    |
| Integration test suite consideration        | ❌ Not addressed (carried forward)    |

---

## Dependencies Validated

| Dependency                   | Source     | Usage                       |
| ---------------------------- | ---------- | --------------------------- |
| safetySettingChangeSchema    | Epic 3A.2  | Two-parent approval pattern |
| caregiverRemovedNotification | Story 39.7 | Child notification pattern  |
| fleeing mode patterns        | Epic 0.5   | 72-hour suppression         |
| auditLogSchema               | Epic 27    | Transition audit logging    |
| screenTimeRuleSchema         | Epic 30-31 | Time limits at locations    |

---

## Metrics

- **Stories Completed:** 6/6 (100%)
- **Tasks Completed:** 56/56 (100%)
- **Total Tests:** 986+
- **Test Files:** 50+
- **Lint Errors Fixed:** 5 (before commits)
- **Security Features:** Dual-consent, instant disable, Safe Escape, abuse detection
- **Safety Features:** 72-hour silent period, non-configurable thresholds, bilateral alerts

---

## Action Items for Future Epics

1. **Testing:** Document vi.hoisted() pattern for ESM mock hoisting
2. **Testing:** Document static vs dynamic imports requirement
3. **Process:** Run lint after EACH file modification, not just at end
4. **Carry Forward:** Firestore mock helper utility (from Epic 39)
5. **Carry Forward:** Firestore migration patterns (from Epic 38)
6. **Carry Forward:** Integration test suite consideration (from Epic 38)

---

## Conclusion

Epic 40 delivered a comprehensive location-based rule system designed specifically for the complexities of shared custody arrangements. The implementation prioritizes child safety (Safe Escape mode with 72-hour silent period), prevents abuse of location features (non-configurable detection thresholds, bilateral alerts), and maintains transparency (child sees same data as parents).

**Key Achievements:**

- Dual-guardian consent for location feature activation
- Single-guardian instant disable for safety
- Safe Escape mode with survivor advocacy protections
- Geofence-based rules with configurable zones
- 5-minute grace period for location transitions
- Child privacy controls with bilateral transparency
- Abuse pattern detection with auto-disable capability
- 986+ tests ensuring reliability

**Epic 40 marks the completion of Phase 4: Caregivers & Advanced Custody.**

**Next Phase:**

- Phase 5: Platform Expansion (Epics 41-46) - Notifications, Fire TV, iOS, Windows/macOS, gaming consoles
- Or Phase 6: Operations & Self-Hosting (Epics 48-52) - Terraform deployment, backups, subscriptions
